<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Agente de Consulta de Ex√°menes</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			height: 100vh;
			display: flex;
			justify-content: center;
			align-items: center;
		}

		.container {
			width: 90%;
			max-width: 900px;
			height: 85vh;
			background: white;
			border-radius: 20px;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}

		.header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 20px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.header h1 {
			font-size: 24px;
			font-weight: 600;
		}

		.legajo-section {
			display: flex;
			gap: 10px;
			align-items: center;
		}

		.legajo-section input {
			padding: 8px 12px;
			border: none;
			border-radius: 8px;
			font-size: 14px;
			width: 150px;
		}

		.legajo-section button {
			padding: 8px 16px;
			background: white;
			color: #667eea;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-weight: 600;
			transition: transform 0.2s;
		}

		.legajo-section button:hover {
			transform: scale(1.05);
		}

		.legajo-section button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.chat-container {
			flex: 1;
			overflow-y: auto;
			padding: 20px;
			background: #f8f9fa;
		}

		.message {
			margin-bottom: 15px;
			display: flex;
			animation: fadeIn 0.3s;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.message.user {
			justify-content: flex-end;
		}

		.message-content {
			max-width: 70%;
			padding: 12px 16px;
			border-radius: 18px;
			word-wrap: break-word;
		}

		.message.user .message-content {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border-bottom-right-radius: 4px;
		}

		.message.agent .message-content {
			background: white;
			color: #333;
			border-bottom-left-radius: 4px;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
		}

		.message.system .message-content {
			background: #e3f2fd;
			color: #1976d2;
			text-align: center;
			max-width: 100%;
			font-style: italic;
		}

		.input-container {
			padding: 20px;
			background: white;
			border-top: 1px solid #e0e0e0;
			display: flex;
			gap: 10px;
		}

		.input-container input {
			flex: 1;
			padding: 12px 16px;
			border: 2px solid #e0e0e0;
			border-radius: 24px;
			font-size: 14px;
			outline: none;
			transition: border-color 0.3s;
		}

		.input-container input:focus {
			border-color: #667eea;
		}

		.input-container input:disabled {
			background: #f5f5f5;
			cursor: not-allowed;
		}

		.input-container button {
			padding: 12px 24px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border: none;
			border-radius: 24px;
			cursor: pointer;
			font-weight: 600;
			transition: transform 0.2s, opacity 0.2s;
		}

		.input-container button:hover:not(:disabled) {
			transform: scale(1.05);
		}

		.input-container button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.loading-indicator {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 10px;
			color: #666;
		}

		.loading-spinner {
			display: inline-block;
			width: 16px;
			height: 16px;
			border: 2px solid #e0e0e0;
			border-radius: 50%;
			border-top-color: #667eea;
			animation: spin 0.8s linear infinite;
		}

		@keyframes spin {
			to { transform: rotate(360deg); }
		}

		.message.loading .message-content {
			background: #f5f5f5;
			border: 1px dashed #ddd;
			animation: pulse 1.5s ease-in-out infinite;
		}

		@keyframes pulse {
			0%, 100% {
				opacity: 1;
			}
			50% {
				opacity: 0.6;
			}
		}

		.status-indicator {
			display: inline-block;
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: #4caf50;
			margin-left: 8px;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<h1>ü§ñ Agente de Consulta de Ex√°menes</h1>
			<div class="legajo-section">
				<input type="text" id="legajo-input" placeholder="Legajo" value="" />
				<button id="login-btn" onclick="setLegajo()">Iniciar</button>
				<span class="status-indicator" id="status-indicator" style="display: none;"></span>
			</div>
		</div>
		<div class="chat-container" id="chat"></div>
		<div class="input-container">
			<input type="text" id="message-input" placeholder="Escribe tu mensaje..." disabled />
			<button id="send-btn" onclick="sendMessage()" disabled>Enviar</button>
		</div>
	</div>

	<script>
		let legajo = null;
		let isProcessing = false;

		function setLegajo() {
			const input = document.getElementById('legajo-input');
			legajo = input.value.trim();
			if (legajo) {
				document.getElementById('message-input').disabled = false;
				document.getElementById('send-btn').disabled = false;
				document.getElementById('login-btn').disabled = true;
				document.getElementById('legajo-input').disabled = true;
				document.getElementById('status-indicator').style.display = 'inline-block';
				addMessage('Sistema', `Sesi√≥n iniciada con legajo: ${legajo}. ¬°Hola! Puedes hacer preguntas sobre los temas de estudio, consultar tu nivel de conocimiento, pedir ejercicios y m√°s.`, 'system');
				document.getElementById('message-input').focus();
			}
		}

		async function sendMessage() {
			const input = document.getElementById('message-input');
			const message = input.value.trim();
			if (!message || !legajo || isProcessing) return;

			addMessage('T√∫', message, 'user');
			input.value = '';
			isProcessing = true;
			document.getElementById('send-btn').disabled = true;

			// Show loading indicator with better styling
			const loadingMsg = addLoadingMessage();

			try {
				const response = await fetch('/api/chat', {
					method: 'POST',
					headers: {'Content-Type': 'application/json'},
					body: JSON.stringify({legajo: legajo, message: message})
				});

				if (!response.ok) {
					throw new Error(`Error ${response.status}: ${response.statusText}`);
				}

				const data = await response.json();
				
				// Remove loading message
				loadingMsg.remove();
				
				// Add response message
				addMessage('Agente', data.response, 'agent');
			} catch (error) {
				loadingMsg.remove();
				addMessage('Sistema', `Error al enviar mensaje: ${error.message}`, 'system');
			} finally {
				isProcessing = false;
				document.getElementById('send-btn').disabled = false;
				input.focus();
			}
		}

		function addLoadingMessage() {
			const chat = document.getElementById('chat');
			const div = document.createElement('div');
			div.className = 'message loading agent';
			div.innerHTML = `
				<div class="message-content loading-indicator">
					<div class="loading-spinner"></div>
					<span>Pensando...</span>
				</div>
			`;
			chat.appendChild(div);
			chat.scrollTop = chat.scrollHeight;
			return div;
		}

		function addMessage(sender, text, type) {
			const chat = document.getElementById('chat');
			const div = document.createElement('div');
			div.className = `message ${type}`;
			
			// Skip formatting if text contains HTML (like loading indicator)
			if (text.includes('<span') || text.includes('<div')) {
				div.innerHTML = `<div class="message-content">${text}</div>`;
			} else {
				// Escape HTML for security first
				let formattedText = text
					.replace(/&/g, '&amp;')
					.replace(/</g, '&lt;')
					.replace(/>/g, '&gt;');
				
				// Convert separator lines to horizontal rules (before converting newlines)
				// Only convert long separator lines, not short ones like "---"
				formattedText = formattedText.replace(/={30,}/g, '<hr style="border: none; border-top: 2px solid #e0e0e0; margin: 12px 0;">');
				// Convert "---" to a subtle separator
				formattedText = formattedText.replace(/^---$/gm, '<hr style="border: none; border-top: 1px solid #e0e0e0; margin: 10px 0;">');
				
				// Convert newlines to <br> (after converting separators)
				formattedText = formattedText.replace(/\n/g, '<br>');
				
				// Detect structured content (exercises) for better styling
				const isExercise = text.includes('EJERCICIO') && text.includes('ENUNCIADO');
				const isExerciseList = text.includes('EJERCICIOS DISPONIBLES') || text.includes('EJERCICIOS RECOMENDADOS');
				
				// Apply better styling for structured content
				let contentStyle = '';
				let wrapperStyle = '';
				if (isExercise) {
					// Clean, modern styling for individual exercises
					contentStyle = 'font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 1em; line-height: 1.8; color: #2c3e50;';
					// Highlight the ENUNCIADO section
					formattedText = formattedText.replace(/ENUNCIADO:/g, '<strong style="color: #667eea; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">ENUNCIADO:</strong>');
					// Style the exercise title
					formattedText = formattedText.replace(/^EJERCICIO - (.*?)$/gm, '<strong style="color: #667eea; font-size: 1.1em; display: block; margin-bottom: 8px;">EJERCICIO - $1</strong>');
					// Add subtle background and border for exercise boxes
					wrapperStyle = 'background: linear-gradient(to right, #ffffff 0%, #f8f9fa 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1); margin: 8px 0;';
					formattedText = `<div style="${wrapperStyle}">${formattedText}</div>`;
				} else if (isExerciseList) {
					// Styling for exercise lists
					contentStyle = 'font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 0.95em; line-height: 1.7; color: #333;';
					wrapperStyle = 'background: #f8f9fa; padding: 16px; border-radius: 8px; border-left: 3px solid #667eea;';
					formattedText = `<div style="${wrapperStyle}">${formattedText}</div>`;
				}
				
				div.innerHTML = `<div class="message-content" style="${contentStyle}">${formattedText}</div>`;
			}
			
			chat.appendChild(div);
			chat.scrollTop = chat.scrollHeight;
			return div;
		}

		// Allow sending message with Enter key
		document.getElementById('message-input').addEventListener('keypress', function(e) {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				sendMessage();
			}
		});

		// Allow setting legajo with Enter key
		document.getElementById('legajo-input').addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
				e.preventDefault();
				setLegajo();
			}
		});

		// Check if server is running
		async function checkHealth() {
			try {
				const response = await fetch('/api/health');
				if (response.ok) {
					document.getElementById('status-indicator').style.background = '#4caf50';
				}
			} catch (error) {
				document.getElementById('status-indicator').style.background = '#f44336';
			}
		}

		checkHealth();
		setInterval(checkHealth, 30000); // Check every 30 seconds
	</script>
</body>
</html>

